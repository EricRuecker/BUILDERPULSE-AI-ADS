name: Generate X Post Files

on:
  workflow_dispatch:
    inputs:
      count:
        description: "How many X posts to generate"
        required: true
        default: "30"
      start_date:
        description: "Start date (YYYY-MM-DD). Leave blank = tomorrow (UTC)."
        required: false
        default: ""
      prefix:
        description: "ID prefix"
        required: false
        default: "x"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate X markdown posts (Python)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, re
          from pathlib import Path
          from datetime import datetime, timedelta, timezone

          posts_dir = Path("posts")
          posts_dir.mkdir(parents=True, exist_ok=True)

          count = int(os.environ.get("COUNT", "30"))
          prefix = os.environ.get("PREFIX", "x").strip()

          start = os.environ.get("START", "").strip()
          now = datetime.now(timezone.utc)
          if not start:
            start_date = (now + timedelta(days=1)).date()
          else:
            start_date = datetime.strptime(start, "%Y-%m-%d").date()

          # Find next numeric id from existing posts (id: x-###)
          next_num = 0
          id_re = re.compile(rf"^id:\s*{re.escape(prefix)}-(\d+)\s*$", re.IGNORECASE)

          for md in posts_dir.glob("*.md"):
            try:
              txt = md.read_text(encoding="utf-8")
            except Exception:
              continue
            for line in txt.splitlines():
              m = id_re.match(line.strip())
              if m:
                next_num = max(next_num, int(m.group(1)))

          templates = [
            "Builders: stop chasing drawings + texts. BuilderPulseAI keeps jobs organized. Demo: https://www.builderpulse.ca #construction #builders",
            "Spreadsheets don’t run job sites. BuilderPulseAI centralizes docs + tracking so you save hours weekly. https://www.builderpulse.ca #contractor",
            "Less admin, more building. BuilderPulseAI helps you organize projects fast. https://www.builderpulse.ca #constructionmanagement",
            "Job visibility = job profitability. BuilderPulseAI helps track time + docs in one place. https://www.builderpulse.ca #builder",
            "Plans everywhere? Put them in one place. BuilderPulseAI keeps job docs clean + accessible. https://www.builderpulse.ca #construction",
            "Early onboarding: $299/mo (reg $499). Built by a builder. https://www.builderpulse.ca #constructiontech",
            "Your crew shouldn’t wait on info. BuilderPulseAI makes docs accessible in field + office. https://www.builderpulse.ca #fieldops",
            "Reduce rework: keep the latest drawing handy. BuilderPulseAI organizes revisions. https://www.builderpulse.ca #contractorlife",
            "Timecards shouldn’t be chaos. BuilderPulseAI simplifies tracking by job. https://www.builderpulse.ca #payroll",
            "Stop duct-taping systems. BuilderPulseAI replaces spreadsheets + scattered files. https://www.builderpulse.ca #constructiontech",
          ]

          def trim_280(s: str) -> str:
            s = s.replace("\u200b", "").strip()
            return s[:275].rstrip()  # safety buffer

          created = 0
          for i in range(1, count + 1):
            num = next_num + i
            post_id = f"{prefix}-{num:03d}"
            date = start_date + timedelta(days=i-1)
            slug = f"x-update-{num:03d}"
            file = posts_dir / f"{date.isoformat()}-{slug}.md"
            if file.exists():
              continue

            body = trim_280(templates[(i-1) % len(templates)])
            content = f"""---
id: {post_id}
platforms: [x]
status: ready
---

{body}
"""
            file.write_text(content, encoding="utf-8")
            created += 1

          print(f"Created {created} X post file(s).")
          PY
        env:
          COUNT: ${{ github.event.inputs.count }}
          PREFIX: ${{ github.event.inputs.prefix }}
          START: ${{ github.event.inputs.start_date }}

      - name: Commit files
        run: |
          git config user.name "actions-user"
          git config user.email "actions@users.noreply.github.com"
          git add posts/*.md || true
          git diff --staged --quiet || git commit -m "Generate X post templates"
          git push
