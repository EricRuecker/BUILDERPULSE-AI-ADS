name: Generate Post Files

on:
  workflow_dispatch:
    inputs:
      count:
        description: "How many posts to generate"
        required: true
        default: "30"
      start_date:
        description: "Start date (YYYY-MM-DD). Leave blank = tomorrow."
        required: false
        default: ""
      prefix:
        description: "ID prefix (e.g. fb)"
        required: false
        default: "fb"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate markdown posts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p posts

          COUNT="${{ github.event.inputs.count }}"
          PREFIX="${{ github.event.inputs.prefix }}"
          START="${{ github.event.inputs.start_date }}"

          if [ -z "$START" ]; then
            START="$(date -u -d "tomorrow" +%F)"
          fi

          # Find the next numeric id (fb-###) based on existing files
          NEXT_NUM=$(grep -RhoE '^id:\s*'"$PREFIX"'-[0-9]+' posts/*.md 2>/dev/null \
            | sed -E 's/.*'"$PREFIX"'-([0-9]+)/\1/' \
            | sort -n | tail -1)
          if [ -z "${NEXT_NUM:-}" ]; then NEXT_NUM=0; fi

          for i in $(seq 1 "$COUNT"); do
            NUM=$((NEXT_NUM + i))
            ID=$(printf "%s-%03d" "$PREFIX" "$NUM")
            DATE=$(date -u -d "$START +$((i-1)) day" +%F)
            SLUG=$(printf "builderpulse-update-%03d" "$NUM")

            FILE="posts/${DATE}-${SLUG}.md"
            if [ -f "$FILE" ]; then
              echo "Skip exists: $FILE"
              continue
            fi

            cat > "$FILE" <<EOF
---
id: $ID
platforms: [facebook]
status: ready
---

ðŸš€ BuilderPulseAI is live.

(Write post copy here for $ID)
ðŸ‘‰ https://www.builderpulse.ca
EOF
            echo "Created: $FILE"
          done

      - name: Commit files
        run: |
          git config user.name "actions-user"
          git config user.email "actions@users.noreply.github.com"
          git add posts/*.md
          git diff --staged --quiet || git commit -m "Generate post templates"
          git push
